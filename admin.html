<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hina Organic - Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif;}
    body{
      min-height:100vh;
      background:#020617;
      color:#e5e7eb;
      padding:16px;
    }
    .wrap{
      max-width:960px;
      margin:0 auto;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .logo-badge{
      width:32px;height:32px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#bbf7d0,#22c55e);
      display:flex;align-items:center;justify-content:center;
      color:#022c22;font-weight:700;
      box-shadow:0 10px 26px rgba(34,197,94,0.7);
    }
    .logo span{
      display:block;font-size:12px;
    }
    .logo small{
      display:block;font-size:10px;color:#9ca3af;
    }
    .tag{
      font-size:10px;color:#9ca3af;
    }
    .card{
      background:#020617;
      border-radius:18px;
      padding:12px;
      border:1px solid #1f2937;
      box-shadow:0 16px 40px rgba(0,0,0,0.8);
      margin-bottom:14px;
    }
    h2{
      font-size:18px;
      margin-bottom:6px;
    }
    h3{
      font-size:15px;
      margin-bottom:6px;
    }
    .field{
      margin-bottom:8px;
      font-size:12px;
    }
    .field label{
      display:block;margin-bottom:3px;color:#9ca3af;
    }
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:10px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      padding:6px 8px;
      font-size:12px;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-primary{
      background:linear-gradient(120deg,#22c55e,#16a34a);
      color:#022c22;
      box-shadow:0 12px 30px rgba(34,197,94,0.7);
    }
    .btn-ghost{
      background:transparent;
      border:1px solid #374151;
      color:#e5e7eb;
    }
    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .col{
      flex:1;
      min-width:260px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:6px;
    }
    th,td{
      padding:6px 4px;
      border-bottom:1px solid #111827;
      text-align:left;
    }
    th{
      font-size:11px;
      color:#9ca3af;
    }
    tr:nth-child(even){
      background:#020617;
    }
    .status-select{
      background:#020617;
      border-radius:999px;
      border:1px solid #374151;
      color:#e5e7eb;
      padding:2px 6px;
      font-size:11px;
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
    }
    .pill-new{background:#2563eb33;color:#bfdbfe;}
    .pill-progress{background:#facc1533;color:#fde68a;}
    .pill-complete{background:#22c55e33;color:#bbf7d0;}
    .pill-cancel{background:#ef444433;color:#fecaca;}
    .stat-box{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      font-size:12px;
      margin-top:4px;
    }
    .stat{
      padding:6px 8px;
      border-radius:12px;
      background:#020617;
      border:1px solid #1f2937;
    }
    .login-box{
      max-width:320px;
      margin:40px auto;
    }
    footer{
      margin-top:16px;
      font-size:10px;
      color:#6b7280;
      text-align:center;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <div class="logo-badge">H</div>
      <div>
        <span>Hina Organic Admin</span>
        <small>Order control â€¢ Product stock â€¢ WhatsApp updates</small>
      </div>
    </div>
    <div>
      <div class="tag" id="admin-info">Not logged in</div>
    </div>
  </header>

  <!-- LOGIN CARD -->
  <div class="card" id="login-card">
    <div class="login-box">
      <h2>Admin Login</h2>
      <p style="font-size:11px;color:#9ca3af;margin-bottom:8px;">Default: admin / 1234 (baad me change kar sakte ho JSON se).</p>
      <div class="field">
        <label>Username</label>
        <input id="login-username" value="admin">
      </div>
      <div class="field">
        <label>Password</label>
        <input id="login-password" type="password" value="1234">
      </div>
      <button class="btn btn-primary" id="login-btn">Login</button>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="admin-area" style="display:none;">
    <div class="card">
      <h2>Overview</h2>
      <div class="stat-box" id="stats-box">
        <div class="stat" id="stat-orders">Total orders: 0</div>
        <div class="stat" id="stat-revenue">Total revenue: â‚¹0</div>
      </div>
    </div>

    <div class="row">
      <!-- ORDERS -->
      <div class="col">
        <div class="card">
          <h3>Orders</h3>
          <p style="font-size:11px;color:#9ca3af;margin-bottom:4px;">
            Status badlo, aur ek tap me WhatsApp se customer ko update bhejo.
          </p>
          <table id="orders-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name / Phone</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" style="text-align:center;font-size:11px;color:#9ca3af;">Loading orders...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div class="col">
        <div class="card">
          <h3>Products / Cones</h3>
          <table id="products-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>â‚¹</th>
                <th>Min</th>
                <th>Stock</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" style="text-align:center;font-size:11px;color:#9ca3af;">Loading products...</td></tr>
            </tbody>
          </table>

          <hr style="border:none;border-top:1px solid #111827;margin:8px 0;">

          <h3 style="font-size:13px;">Add new cone</h3>
          <div class="field">
            <label>Name</label>
            <input id="p-name" placeholder="Bridal super dark">
          </div>
          <div class="field">
            <label>Price (â‚¹ per cone)</label>
            <input id="p-price" type="number" placeholder="40">
          </div>
          <div class="field">
            <label>Min quantity</label>
            <input id="p-min" type="number" placeholder="5">
          </div>
          <div class="field">
            <label>Category</label>
            <input id="p-cat" placeholder="bridal / party / bulk">
          </div>
          <button class="btn btn-ghost" id="add-product-btn">Add product</button>
        </div>
      </div>
    </div>
  </div>

  <footer>Hina Organic Admin Panel Â· Local JSON storage Â· No database required.</footer>
</div>

<script>
  const OWNER_WHATSAPP_NUMBER = "91XXXXXXXXXX"; // yahan apna WhatsApp number daalo

  let adminToken = localStorage.getItem("hina_admin_token") || "";

  function setLoggedInUI() {
    if (adminToken) {
      document.getElementById("login-card").style.display = "none";
      document.getElementById("admin-area").style.display = "block";
      document.getElementById("admin-info").textContent = "Logged in";
      loadStats();
      loadOrders();
      loadProducts();
    } else {
      document.getElementById("login-card").style.display = "block";
      document.getElementById("admin-area").style.display = "none";
      document.getElementById("admin-info").textContent = "Not logged in";
    }
  }

  // Login
  document.getElementById("login-btn").addEventListener("click", async () => {
    const username = document.getElementById("login-username").value.trim();
    const password = document.getElementById("login-password").value.trim();
    try {
      const res = await fetch("/api/admin/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.error || "Login failed");
      adminToken = data.token;
      localStorage.setItem("hina_admin_token", adminToken);
      setLoggedInUI();
    } catch (e) {
      alert("Login failed: " + e.message);
    }
  });

  // Stats
  async function loadStats() {
    try {
      const res = await fetch("/api/admin/stats", {
        headers:{ "x-admin-token": adminToken }
      });
      const data = await res.json();
      if (!res.ok || !data.success) return;
      document.getElementById("stat-orders").textContent = "Total orders: " + data.totalOrders;
      document.getElementById("stat-revenue").textContent = "Total revenue: â‚¹" + data.totalRevenue;
    } catch(e) { console.error(e); }
  }

  // Orders
  async function loadOrders() {
    const tbody = document.querySelector("#orders-table tbody");
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;font-size:11px;color:#9ca3af;">Loading...</td></tr>';
    try {
      const res = await fetch("/api/admin/orders", {
        headers:{ "x-admin-token": adminToken }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed");

      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;font-size:11px;color:#9ca3af;">No orders yet.</td></tr>';
        return;
      }

      tbody.innerHTML = "";
      data.forEach(o => {
        const tr = document.createElement("tr");
        const st = (o.status || "New").toLowerCase();
        let pillClass = "pill-new";
        if (st.includes("progress")) pillClass = "pill-progress";
        if (st.includes("complete") || st.includes("done")) pillClass = "pill-complete";
        if (st.includes("cancel")) pillClass = "pill-cancel";

        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.customerName || "-"}<br><span style="color:#9ca3af;">${o.phone || ""}</span></td>
          <td><strong>â‚¹${o.total || 0}</strong></td>
          <td>
            <span class="pill ${pillClass}">${o.status || "New"}</span>
            <br>
            <select class="status-select" data-id="${o.id}">
              <option value="New" ${st==="new"?"selected":""}>New</option>
              <option value="In progress" ${st.includes("progress")?"selected":""}>In progress</option>
              <option value="Completed" ${st.includes("complete")?"selected":""}>Completed</option>
              <option value="Cancelled" ${st.includes("cancel")?"selected":""}>Cancelled</option>
            </select>
          </td>
          <td style="font-size:10px;">${o.paymentMethod || "-"}<br><span style="color:#9ca3af;">${o.city || ""}</span></td>
          <td>
            <button class="btn btn-ghost btn-sm wa-btn" data-id="${o.id}">WhatsApp</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Attach status change
      document.querySelectorAll(".status-select").forEach(sel => {
        sel.addEventListener("change", async () => {
          const id = sel.getAttribute("data-id");
          const status = sel.value;
          try {
            await fetch("/api/admin/orders/" + encodeURIComponent(id) + "/status", {
              method:"PATCH",
              headers:{
                "Content-Type":"application/json",
                "x-admin-token": adminToken
              },
              body:JSON.stringify({ status })
            });
            loadOrders();
          } catch(e) {
            alert("Failed to update status");
          }
        });
      });

      // Attach WhatsApp buttons
      document.querySelectorAll(".wa-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const order = data.find(o => o.id === id);
          if (!order) return;
          openWhatsAppForOrder(order);
        });
      });

    } catch(e) {
      console.error(e);
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;font-size:11px;color:#fecaca;">Error loading orders.</td></tr>';
    }
  }

  // Products
  async function loadProducts() {
    const tbody = document.querySelector("#products-table tbody");
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;font-size:11px;color:#9ca3af;">Loading...</td></tr>';
    try {
      const res = await fetch("/api/admin/products", {
        headers:{ "x-admin-token": adminToken }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed");

      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;font-size:11px;color:#9ca3af;">No products.</td></tr>';
        return;
      }
      tbody.innerHTML = "";
      data.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>â‚¹${p.price}</td>
          <td>${p.minQty || 1}</td>
          <td>
            <button class="btn btn-ghost btn-sm stock-btn" data-id="${p.id}">
              ${p.inStock === false ? "Out of stock" : "In stock"}
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll(".stock-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const text = btn.textContent.toLowerCase();
          const newStock = text.includes("out") ? true : false; // toggle
          try {
            await fetch("/api/admin/products/" + encodeURIComponent(id), {
              method:"PATCH",
              headers:{
                "Content-Type":"application/json",
                "x-admin-token": adminToken
              },
              body:JSON.stringify({ inStock: newStock })
            });
            loadProducts();
          } catch(e) {
            alert("Failed to update stock");
          }
        });
      });

    } catch(e) {
      console.error(e);
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;font-size:11px;color:#fecaca;">Error loading products.</td></tr>';
    }
  }

  // Add product
  document.getElementById("add-product-btn").addEventListener("click", async () => {
    const name = document.getElementById("p-name").value.trim();
    const price = document.getElementById("p-price").value.trim();
    const minQty = document.getElementById("p-min").value.trim();
    const cat = document.getElementById("p-cat").value.trim();

    if (!name || !price) {
      alert("Name and price required.");
      return;
    }

    try {
      const res = await fetch("/api/admin/products", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-admin-token": adminToken
        },
        body:JSON.stringify({
          name,
          price,
          minQty,
          category: cat || "other",
          inStock:true
        })
      });
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.error || "Failed");
      document.getElementById("p-name").value = "";
      document.getElementById("p-price").value = "";
      document.getElementById("p-min").value = "";
      document.getElementById("p-cat").value = "";
      loadProducts();
    } catch(e) {
      alert("Failed to add product: " + e.message);
    }
  });

  // WhatsApp update system
  function openWhatsAppForOrder(o) {
    if (!o.phone) {
      alert("Customer phone number missing!");
      return;
    }
    let num = o.phone.replace(/\D/g, "");
    if (num.length === 10) num = "91" + num;

    const msg =
      `Hi ${o.customerName || "Customer"} ðŸ‘‹\n\n` +
      `Your Mehndi Order Update from *Hina Organic Cone*:\n` +
      `Order ID: ${o.id}\n` +
      `Status: ${o.status || "New"}\n` +
      `Total Amount: â‚¹${o.total || 0}\n\n` +
      `Thank you for choosing us ðŸŒ¿`;

    const url = `https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  }

  // Init
  setLoggedInUI();
</script>
</body>
</html>